<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<link crossorigin="" href="https://fonts.gstatic.com/" rel="preconnect"/>
<link as="style" href="https://fonts.googleapis.com/css2?display=swap&amp;family=Public+Sans%3Awght%40400%3B500%3B600%3B700%3B800%3B900" onload="this.rel='stylesheet'" rel="stylesheet"/>
<title>UPDS Marketplace - Detalles del Artículo</title>
<link href="data:image/x-icon;base64," rel="icon" type="image/x-icon"/>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
<script>
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            primary: "#137fec",
            "background-light": "#f6f7f8",
            "background-dark": "#101922",
          },
          fontFamily: { display: ["Public Sans"] },
          borderRadius: { DEFAULT: "0.25rem", lg: "0.5rem", xl: "0.75rem", full: "9999px" },
        },
      },
    };
</script>
</head>
<body class="bg-background-light dark:bg-background-dark font-display text-slate-800 dark:text-slate-200">

<div class="flex min-h-screen w-full flex-col">
<header class="sticky top-0 z-20 bg-white backdrop-blur-sm border-b border-subtle-light dark:border-subtle-dark">
  <div class="container mx-auto px-4 sm:px-6 lg:px-8">
    <div class="flex items-center justify-between h-16">
      <div class="flex items-center gap-4">
        <a class="flex items-center gap-2 text-primary" href="/index.html">
          <img src="/images/UPDS.png" alt="UPDS Logo" class="h-12 w-32" >
          <img src="/images/letras.png" alt="UPDS Logo" class="h-12 w-32" >
        </a>
      </div>
        <nav class="hidden md:flex items-center gap-6">
        <a class="text-lg font-bold text-primary" href="/index.html">Inicio</a>
        <a class="text-lg font-medium text-muted-light dark:text-muted-dark hover:text-primary dark:hover:text-primary transition-colors" href="/Articulos.html">Mis Artículos</a>
        <a class="text-lg font-medium text-muted-light dark:text-muted-dark hover:text-primary dark:hover:text-primary transition-colors" href="/Carrito.html">Mi carrito</a>
        <a class="text-lg font-medium text-muted-light dark:text-muted-dark hover:text-primary dark:hover:text-primary transition-colors" href="/chat.html">Chat</a>
      </nav>
      <div class="flex items-center gap-4">
        <button id="acceso" class="hidden md:inline-flex items-center justify-center px-4 py-2 text-sm font-medium text-white bg-primary rounded-full hover:bg-primary/90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary transition-colors">Acceder</button>
        <button id="perfilBtn" class="relative">
          <img alt="Foto de perfil" class="size-10 rounded-full object-cover" src="https://lh3.googleusercontent.com/aida-public/AB6AXuBPnqmxyZztUymxgQLQ4C9Xmn1Re_6Oust47gFBGuflhIol6uFtmAMW0R3i5-GmhKvTbj9qstzuTY9jIFBq0nefmqxR6Eg7HSwlLPGUnqOs7En0VE6P-Htcx0aQIR5r6ggeAqVBYLnMGkaiqqz2WkwsolMHKrc4_onU-RYGqqIi1Vz7apneYyN_EpNkcbkD6MXNEil4J1dBkc-xbno_-F5bjXzJP6Q3SJjg2YyIKT6ByJ5bi7dmiBqwHfDM0s4pl3lg8hS2GIC_o7E"/>
        </button>
        <button id="notificacion" class="w-10 h-10 flex items-center justify-center rounded-full bg-background-light dark:bg-background-dark hover:bg-black/5 dark:hover:bg-white/5 text-black/60 dark:text-white/60 transition-colors">
            <span class="material-symbols-outlined">
                notifications
            </span>
        </button>
        <button class="md:hidden p-2 rounded-full hover:bg-primary/10 dark:hover:bg-primary/20 transition-colors">
          <span class="material-symbols-outlined text-text-light dark:text-text-dark">menu</span>
        </button>
      </div>
    </div>
  </div>
</header>
<main class="mx-auto w-full max-w-7xl flex-1 px-4 py-8 sm:px-6 lg:px-8">
<div class="grid grid-cols-1 gap-12 lg:grid-cols-5">

  <!-- Columna izquierda: imágenes -->
  <div class="lg:col-span-3">
    <div class="mb-4 text-sm text-slate-500 dark:text-slate-400">
      <a class="hover:text-primary" href="/index.html">Inicio</a>
      <span>/</span>
      <a id="categoria" class="hover:text-primary" href="#"></a>
    </div>
    <h1 id="titulo" class="mb-6 text-4xl font-extrabold tracking-tight text-slate-900 dark:text-white"></h1>
    
    <!-- Imagen principal -->
    <div class="relative">
      <div id="imagenPrincipal" class="h-[450px] w-full flex-shrink-0 rounded-xl bg-cover bg-center"></div>
    </div>

    <!-- Grid de miniaturas -->
    <div id="previewContainer" class="mt-4 grid grid-cols-5 gap-4"></div>
  </div>

  <!-- Columna derecha: detalles del artículo -->
  <div class="lg:col-span-2">
    <div class="sticky top-24 rounded-xl border border-slate-200 bg-white p-6 shadow-lg dark:border-slate-800 dark:bg-background-dark">
      <div class="mb-6 flex items-center justify-between">
        <h2 class="text-2xl font-bold text-slate-900 dark:text-white">Detalles del Artículo</h2>
        <span id="estado" class="rounded-full bg-primary/10 px-3 py-1 text-sm font-semibold text-primary"></span>
      </div>
      <div class="mb-6">
        <h3 class="mb-2 text-lg font-semibold text-slate-900 dark:text-white">Descripción</h3>
        <p id="descripcion" class="text-slate-600 dark:text-slate-300"></p>
      </div>
      <div class="mb-6">
        <h3 class="mb-2 text-lg font-semibold text-slate-900 dark:text-white">Precio</h3>
        <p id="precio" class="text-slate-800 dark:text-white text-lg font-bold"></p>
      </div>
      <div class="mb-6">
        <h3 class="mb-2 text-lg font-semibold text-slate-900 dark:text-white">Cantidad Disponible</h3>
        <p id="stock" class="text-slate-700 dark:text-slate-300"></p>
      </div>
      <!-- Propietario y botón -->
      <div class="mb-6 rounded-lg bg-background-light p-4 dark:bg-slate-800/50">
        <h3 class="mb-3 text-lg font-semibold text-slate-900 dark:text-white">Propietario</h3>
        <div class="flex items-center gap-4">
          <div id="propietarioFoto" class="h-14 w-14 flex-shrink-0 rounded-full bg-cover bg-center"></div>
          <div>
            <input type="hidden" id="vendedorId">
            <p id="propietarioNombre" class="font-bold text-slate-800 dark:text-slate-100"></p>
            <div class="flex items-center gap-1 text-sm text-slate-500 dark:text-slate-400">
              <span class="material-symbols-outlined text-base text-amber-500"> star </span>
              <span id="propietarioRating"></span>
            </div>
          </div>
        </div>
      </div>
      <button id="btnVentas" class="flex h-12 w-full items-center justify-center rounded-lg bg-primary px-6 text-base font-bold text-white shadow-md shadow-primary/30 transition-all hover:bg-primary/90 hover:shadow-lg hover:shadow-primary/40">
        Contactar al Vendedor
      </button>
    </div>
  </div>

</div>
</main>
</div>

<script>
async function cargarDetalle() {
  const params = new URLSearchParams(window.location.search);
  const articuloId = params.get("id");

  if (!articuloId) {
    alert("No se especificó el artículo");
    return;
  }

  try {
    const res = await fetch(`/api/articulos/${articuloId}`);
    const data = await res.json();

    if (!data.success) {
      alert(data.message);
      return;
    }

    const art = data.articulo;

    // Datos básicos
    document.getElementById("titulo").textContent = art.titulo;
    document.getElementById("descripcion").textContent = art.descripcion;
    document.getElementById("precio").textContent = `Bs. ${art.precio}`;
    document.getElementById("stock").textContent = `${art.stock} Unidades`;
    document.getElementById("estado").textContent = art.estado;
    document.getElementById("categoria").textContent = art.categoria;
    document.getElementById("vendedorId").value = art.UsuarioId;

    // Propietario
    document.getElementById("propietarioNombre").textContent = art.usuario + ' ' + art.apellido;
    //document.getElementById("propietarioFoto").style.backgroundImage = `url('${art.usuario.foto || "default.png"}')`;
    //document.getElementById("propietarioRating").textContent = `${art.usuario.rating} (${art.usuario.intercambios} intercambios)`;

    // Imagen principal
    const imagenPrincipal = document.getElementById("imagenPrincipal");
    if (art.imagenes.length > 0) {
      imagenPrincipal.style.backgroundImage = `url('${art.imagenes[0].filename}')`;
    } else {
      imagenPrincipal.style.backgroundImage = `url('default.png')`;
    }

    // Grid de miniaturas
    const previewContainer = document.getElementById("previewContainer");
    previewContainer.innerHTML = "";
    art.imagenes.forEach(img => {
      const thumb = document.createElement("div");
      thumb.className = "h-24 w-full rounded-lg bg-cover bg-center cursor-pointer";
      thumb.style.backgroundImage = `url('${img.filename}')`;
      // Al hacer click cambia la imagen principal
      thumb.addEventListener("click", () => {
        imagenPrincipal.style.backgroundImage = `url('${img.filename}')`;
      });
      previewContainer.appendChild(thumb);
    });

  } catch (err) {
    console.error(err);
    alert("Error al cargar el artículo");
  }
}

cargarDetalle();
</script>

<script>
document.getElementById("btnVentas").addEventListener("click", async () => {


  try {
    const res = await fetch("/api/session"); // Endpoint que valida sesión
    const data = await res.json();
    console.log("Sesión:", data);

    if (data.loggedIn) {
      const compradorId = data.idUsuario; // ID de la sesión
      const vendedorId = document.getElementById("vendedorId").value; // ID del input

      // POST para crear/abrir chat
      const chatRes = await fetch("/api/chats", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ compradorId, vendedorId })
      });

      if (!chatRes.ok) throw new Error("Error creando chat");

      const chatData = await chatRes.json();

      // Redirigir al chat con el ID
      window.location.href = `chat.html?chatId=${chatData.chatId}`;
    } else {
      // Usuario no está logueado, preguntar
      const confirmar = confirm("Debes iniciar sesión para contactar al vendedor. ¿Deseas iniciar sesión ahora?");
      if (confirmar) {
        window.location.href = "iniciosesion.html"; // Página de inicio de sesión
      }
    }
  } catch (err) {
    console.error("Error verificando sesión:", err);
    alert("No se pudo verificar la sesión. Intenta de nuevo.");
  }
});
</script>

</body>
</html>
